<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- iOS Viewport Optimization: Prevents zooming and handles the notch -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Super Web Bros</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            touch-action: none; /* Disables browser gestures */
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-user-select: none;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Virtual Controls Overlay */
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 150px;
            pointer-events: none; /* Let clicks pass through to canvas if needed */
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 100;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            backdrop-filter: blur(4px);
            pointer-events: auto;
            touch-action: manipulation;
        }

        .btn:active {
            background: rgba(255, 255, 255, 0.5);
        }

        #dpad {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .arrow {
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
        }

        #actions {
            display: flex;
            align-items: center;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 0, 0, 0.3);
            color: white;
            font-weight: bold;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Rotate instruction for landscape */
        #rotate-msg {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #333;
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        @media screen and (orientation: portrait) {
           /* Optional: Force landscape hint if you want strictly landscape */
        }
    </style>
</head>
<body>

    <!-- Touch Controls -->
    <div id="controls">
        <div id="dpad">
            <div class="btn arrow" id="btn-left">←</div>
            <div class="btn arrow" id="btn-right">→</div>
        </div>
        <div id="actions">
            <div class="btn action-btn" id="btn-jump">A</div>
        </div>
    </div>

    <!-- Kaboom.js CDN -->
    <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>

    <script>
        // 1. Initialize Kaboom
        kaboom({
            background: [135, 206, 235], // Sky Blue
            scale: 1.5, // Retro pixel feel
        });

        // 2. Load Assets (Using built-in sprites for copyright safety)
        // REPLACE THESE URLS with your own Mario assets to "reskin" the game.
        loadSprite("hero", "https://kaboomjs.com/sprites/bean.png"); 
        loadSprite("enemy", "https://kaboomjs.com/sprites/ghosty.png"); 
        loadSprite("brick", "https://kaboomjs.com/sprites/brick.png");
        loadSprite("block", "https://kaboomjs.com/sprites/box.png");
        loadSprite("mushroom", "https://kaboomjs.com/sprites/mushroom.png");
        loadSprite("surprise", "https://kaboomjs.com/sprites/surprise.png");
        loadSprite("coin", "https://kaboomjs.com/sprites/coin.png");
        loadSprite("pipe", "https://kaboomjs.com/sprites/pipe.png");

        // 3. Define Game Logic
        scene("game", ({ levelId, score }) => {
            
            // UI: Score
            const scoreLabel = add([
                text(score),
                pos(24, 24),
                fixed(),
                z(100)
            ]);

            // Physics Constants
            const MOVE_SPEED = 140;
            const JUMP_FORCE = 450;
            const BIG_JUMP_FORCE = 550;
            let CURRENT_JUMP_FORCE = JUMP_FORCE;
            let isBig = false;
            const FALL_DEATH = 600;

            // Level Layout
            // Symbols map to game objects
            const LEVELS = [
                [
                    "                                      ",
                    "                                      ",
                    "        $$                            ",
                    "      %==%=                           ",
                    "                                      ",
                    "                                   -+ ",
                    "                    ^  ^           () ",
                    "==============================   =====",
                ],
                [
                    "                                      ",
                    "                                      ",
                    "         ====                         ",
                    "      =                               ",
                    "                                   -+ ",
                    "                    ^              () ",
                    "==============================   =====",
                ]
            ];

            const levelConf = {
                tileWidth: 20,
                tileHeight: 20,
                tiles: {
                    "=": () => [sprite("brick"), area(), body({ isStatic: true }), "ground"],
                    "%": () => [sprite("surprise"), area(), body({ isStatic: true }), "coin-box"],
                    "$": () => [sprite("surprise"), area(), body({ isStatic: true }), "mushy-box"],
                    "^": () => [sprite("enemy"), area(), body(), anchor("bot"), patrol(), "danger"],
                    "-": () => [sprite("pipe"), area(), body({ isStatic: true }), scale(1, 2), "pipe"],
                    "+": () => [sprite("pipe"), area(), body({ isStatic: true }), scale(1, 2), "pipe-top"],
                    "(": () => [sprite("pipe"), area(), body({ isStatic: true }), scale(1, 2), "pipe-bottom"],
                    ")": () => [sprite("pipe"), area(), body({ isStatic: true }), scale(1, 2), "pipe-bottom-r"],
                }
            };

            const level = addLevel(LEVELS[levelId % LEVELS.length], levelConf);

            // The Player
            const player = add([
                sprite("hero"),
                pos(0, 0),
                area(),
                body(),
                anchor("bot"),
                "player"
            ]);

            // Camera follows player
            player.onUpdate(() => {
                camPos(player.pos.x + 100, 200);
                if (player.pos.y >= FALL_DEATH) {
                    go("lose", { score: scoreLabel.text });
                }
            });

            // Controls: Keyboard
            onKeyDown("left", () => {
                player.move(-MOVE_SPEED, 0);
                player.flipX = true;
            });
            onKeyDown("right", () => {
                player.move(MOVE_SPEED, 0);
                player.flipX = false;
            });
            onKeyPress("space", () => {
                if (player.isGrounded()) {
                    player.jump(CURRENT_JUMP_FORCE);
                }
            });

            // Controls: Touch (Mobile Integration)
            const btnLeft = document.getElementById('btn-left');
            const btnRight = document.getElementById('btn-right');
            const btnJump = document.getElementById('btn-jump');

            let leftInterval, rightInterval;

            // Touch Helpers
            const touchStart = (el, action) => {
                el.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    action(true);
                }, {passive: false});
                el.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    action(false);
                }, {passive: false});
                // Mouse fallback for testing on desktop
                el.addEventListener('mousedown', () => action(true));
                el.addEventListener('mouseup', () => action(false));
            };

            touchStart(btnLeft, (active) => {
                if (active) {
                    leftInterval = setInterval(() => {
                        player.move(-MOVE_SPEED, 0);
                        player.flipX = true;
                    }, 16);
                } else {
                    clearInterval(leftInterval);
                }
            });

            touchStart(btnRight, (active) => {
                if (active) {
                    rightInterval = setInterval(() => {
                        player.move(MOVE_SPEED, 0);
                        player.flipX = false;
                    }, 16);
                } else {
                    clearInterval(rightInterval);
                }
            });

            touchStart(btnJump, (active) => {
                if (active && player.isGrounded()) {
                    player.jump(CURRENT_JUMP_FORCE);
                }
            });

            // Game Interactions
            player.onHeadbutt((obj) => {
                if (obj.is("coin-box")) {
                    destroy(obj);
                    add([sprite("block"), pos(obj.pos), area(), body({ isStatic: true })]);
                    add([sprite("coin"), pos(obj.pos.sub(0, 20)), area(), move(UP, 100), "coin-fx"]);
                    scoreLabel.text += 100;
                }
                if (obj.is("mushy-box")) {
                    destroy(obj);
                    add([sprite("block"), pos(obj.pos), area(), body({ isStatic: true })]);
                    add([sprite("mushroom"), pos(obj.pos.sub(0, 20)), area(), body(), move(RIGHT, 60), "mushroom"]);
                }
            });

            player.onCollide("mushroom", (m) => {
                destroy(m);
                player.scale = vec2(1.5); // Grow big
                isBig = true;
                CURRENT_JUMP_FORCE = BIG_JUMP_FORCE;
            });

            player.onCollide("danger", (d) => {
                if (isBig) {
                    isBig = false;
                    player.scale = vec2(1);
                    CURRENT_JUMP_FORCE = JUMP_FORCE;
                    destroy(d); // Sacrifice enemy to save player
                } else {
                    go("lose", { score: scoreLabel.text });
                }
            });

            // Stomp enemy
            player.onGround((l) => {
                if (l.is("danger")) {
                    player.jump(JUMP_FORCE * 1.2);
                    destroy(l);
                    addKaboom(l.pos);
                }
            });

            player.onCollide("pipe", () => {
                onKeyPress("down", () => {
                    go("game", {
                        levelId: levelId + 1,
                        score: scoreLabel.text
                    });
                });
            });
        });

        // Custom Component: Patrol AI
        function patrol(speed = 60, dir = 1) {
            return {
                id: "patrol",
                require: ["pos", "area"],
                add() {
                    this.on("collide", (obj, col) => {
                        if (col.isLeft() || col.isRight()) {
                            dir = -dir;
                        }
                    });
                },
                update() {
                    this.move(speed * dir, 0);
                },
            };
        }

        scene("lose", ({ score }) => {
            add([text(score, 32), pos(width() / 2, height() / 2 - 40), anchor("center")]);
            add([
                text("Game Over\nTap to Restart", { size: 24 }),
                pos(width() / 2, height() / 2 + 20),
                anchor("center"),
            ]);

            onKeyPress("space", () => go("game", { levelId: 0, score: 0 }));
            onClick(() => go("game", { levelId: 0, score: 0 }));
            onTouchStart(() => go("game", { levelId: 0, score: 0 }));
        });

        go("game", { levelId: 0, score: 0 });
        
    </script>
</body>
</html>